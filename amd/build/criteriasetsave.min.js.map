{"version":3,"sources":["../src/criteriasetsave.js"],"names":["define","$","ajax","notification","str","templates","ModalFactory","ModalEvents","saveSet","modal","contextId","modalNode","getRoot","nameNode","find","rawName","val","trim","shared","spinner","name","charAt","toUpperCase","slice","prop","show","criteria","parent","each","length","descNode","next","descText","text","push","description","request","call","methodname","args","contextid","done","response","hide","alert","title","body","label","fail","exception","always","init","canPublish","get_string","trigger","create","render","type","types","SAVE_CANCEL","large","getFooter","on","save","e","preventDefault","hidden"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Launches a modal dialogue that enables users to save the configured criteria set for the structured feedback plugin.\n *\n * See template: assignfeedback_structured/criteriasetsave\n *\n * @module     assignfeedback_structured/criteriasetsave\n * @class      criteriasetsave\n * @package    assignfeedback_structured\n * @copyright  2017 Lancaster University {@link http://www.lancaster.ac.uk/}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author     Tony Butler <a.butler4@lancaster.ac.uk>\n */\ndefine(\n    [\n        'jquery',\n        'core/ajax',\n        'core/notification',\n        'core/str',\n        'core/templates',\n        'core/modal_factory',\n        'core/modal_events'\n    ],\n    function($, ajax, notification, str, templates, ModalFactory, ModalEvents) {\n        var criteriaSetSave = {\n            /**\n             * Init function.\n             *\n             * @param {number} contextId The context ID of the current assignment instance.\n             * @param {boolean} canPublish Whether the current user can publish criteria sets.\n             */\n            init: function(contextId, canPublish) {\n                str.get_string('criteriasetsave', 'assignfeedback_structured').done(function(title) {\n                    var context = {\n                        canPublish: canPublish\n                    };\n                    var trigger = $('#id_assignfeedback_structured_critsetsave');\n                    ModalFactory.create({\n                        title: title,\n                        body: templates.render('assignfeedback_structured/criteriasetsave', context),\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        large: false\n                    }, trigger).done(function(modal) {\n                        // Disable save button initially.\n                        modal.getFooter().find('[data-action=\"save\"]').prop('disabled', true);\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n                            e.preventDefault();\n                            saveSet(modal, contextId);\n                        });\n                        // Clear field values on hide.\n                        modal.getRoot().on(ModalEvents.hidden, function() {\n                            $(this).find('[name=\"criteriaset-name\"]').val('');\n                            $(this).find('[name=\"criteriaset-publish\"]').prop('checked', false);\n                            $(this).find('[data-action=\"save\"]').prop('disabled', true);\n                        });\n                    }).fail(notification.exception);\n                }).fail(notification.exception);\n            }\n        };\n\n        /**\n         * Function to gather the criteria data and call a web service method via AJAX to save as a named criteria set.\n         *\n         * @param {object} modal The modal dialogue containing the criteria set save data.\n         * @param {number} contextId The context ID of the current assignment instance.\n         */\n        function saveSet(modal, contextId) {\n            var modalNode = modal.getRoot(),\n                nameNode = modalNode.find('[name=\"criteriaset-name\"]'),\n                rawName = nameNode.val().trim(),\n                shared = false,\n                spinner = modalNode.find('.loading-icon');\n\n            var name = rawName.charAt(0).toUpperCase() + rawName.slice(1);\n            nameNode.val(name);\n            if (modalNode.find('[name=\"criteriaset-publish\"]').prop('checked')) {\n                shared = true;\n            }\n            spinner.show();\n\n            var criteria = [];\n            modalNode.parent().parent().find('[id^=\"id_assignfeedback_structured_critname\"]').each(function() {\n                if ($(this).val().trim().length) {\n                    var descNode = $(this).parent().parent().next().find('[name^=\"assignfeedback_structured_critdesc\"]');\n                    if (!descNode.length) {\n                        descNode = $(this).parent().parent().next().find('[data-fieldtype=\"textarea\"]');\n                    }\n                    var descText;\n                    if (descNode.val()) {\n                        descText = descNode.val().trim();\n                    } else if (descNode.text()) {\n                        descText = descNode.text().trim();\n                    } else {\n                        descText = '';\n                    }\n                    criteria.push({\n                        name: $(this).val().trim(),\n                        description: descText\n                    });\n                }\n            });\n\n            var request = ajax.call([{\n                methodname: 'assignfeedback_structured_save_criteriaset',\n                args: {\n                    contextid: contextId,\n                    name: name,\n                    criteria: criteria,\n                    shared: shared\n                }\n            }]);\n\n            request[0].done(function(response) {\n                if (response.hide === true) {\n                    modal.hide();\n                    $('#id_assignfeedback_structured_critsetsmanage').prop('disabled', false);\n                }\n                notification.alert(response.title, response.body, response.label);\n            }).fail(notification.exception).always(function() {\n                spinner.hide();\n            });\n        }\n\n        return criteriaSetSave;\n    }\n);\n"],"file":"criteriasetsave.min.js"}