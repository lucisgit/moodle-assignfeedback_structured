{"version":3,"file":"criteriasetsave.min.js","sources":["../src/criteriasetsave.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Launches a modal dialogue that enables users to save the configured criteria set for the structured feedback plugin.\n *\n * See template: assignfeedback_structured/criteriasetsave\n *\n * @module     assignfeedback_structured/criteriasetsave\n * @class      criteriasetsave\n * @copyright  2017 Lancaster University {@link http://www.lancaster.ac.uk/}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author     Tony Butler <a.butler4@lancaster.ac.uk>\n */\ndefine(\n    [\n        'jquery',\n        'core/ajax',\n        'core/notification',\n        'core/str',\n        'core/templates',\n        'core/modal_factory',\n        'core/modal_events'\n    ],\n    function($, ajax, notification, str, templates, ModalFactory, ModalEvents) {\n        var criteriaSetSave = {\n            /**\n             * Init function.\n             *\n             * @param {number} contextId The context ID of the current assignment instance.\n             * @param {boolean} canPublish Whether the current user can publish criteria sets.\n             */\n            init: function(contextId, canPublish) {\n                str.get_string('criteriasetsave', 'assignfeedback_structured').done(function(title) {\n                    var context = {\n                        canPublish: canPublish\n                    };\n                    var trigger = $('#id_assignfeedback_structured_critsetsave');\n                    ModalFactory.create({\n                        title: title,\n                        body: templates.render('assignfeedback_structured/criteriasetsave', context),\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        large: false\n                    }, trigger).done(function(modal) {\n                        // Disable save button initially.\n                        modal.getFooter().find('[data-action=\"save\"]').prop('disabled', true);\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n                            e.preventDefault();\n                            saveSet(modal, contextId);\n                        });\n                        // Clear field values on hide.\n                        modal.getRoot().on(ModalEvents.hidden, function() {\n                            $(this).find('[name=\"criteriaset-name\"]').val('');\n                            $(this).find('[name=\"criteriaset-publish\"]').prop('checked', false);\n                            $(this).find('[data-action=\"save\"]').prop('disabled', true);\n                        });\n                    }).fail(notification.exception);\n                }).fail(notification.exception);\n            }\n        };\n\n        /**\n         * Function to gather the criteria data and call a web service method via AJAX to save as a named criteria set.\n         *\n         * @param {object} modal The modal dialogue containing the criteria set save data.\n         * @param {number} contextId The context ID of the current assignment instance.\n         */\n        function saveSet(modal, contextId) {\n            var modalNode = modal.getRoot(),\n                nameNode = modalNode.find('[name=\"criteriaset-name\"]'),\n                rawName = nameNode.val().trim(),\n                shared = false,\n                spinner = modalNode.find('.loading-icon');\n\n            var name = rawName.charAt(0).toUpperCase() + rawName.slice(1);\n            nameNode.val(name);\n            if (modalNode.find('[name=\"criteriaset-publish\"]').prop('checked')) {\n                shared = true;\n            }\n            spinner.show();\n\n            var criteria = [];\n            modalNode.parent().parent().find('[id^=\"id_assignfeedback_structured_critname\"]').each(function() {\n                if ($(this).val().trim().length) {\n                    var descNode = $(this).parent().parent().next().find('[name^=\"assignfeedback_structured_critdesc\"]');\n                    if (!descNode.length) {\n                        descNode = $(this).parent().parent().next().find('[data-fieldtype=\"textarea\"]');\n                    }\n                    var descText;\n                    if (descNode.val()) {\n                        descText = descNode.val().trim();\n                    } else if (descNode.text()) {\n                        descText = descNode.text().trim();\n                    } else {\n                        descText = '';\n                    }\n                    criteria.push({\n                        name: $(this).val().trim(),\n                        description: descText\n                    });\n                }\n            });\n\n            var request = ajax.call([{\n                methodname: 'assignfeedback_structured_save_criteriaset',\n                args: {\n                    contextid: contextId,\n                    name: name,\n                    criteria: criteria,\n                    shared: shared\n                }\n            }]);\n\n            request[0].done(function(response) {\n                if (response.hide === true) {\n                    modal.hide();\n                    $('#id_assignfeedback_structured_critsetsmanage').prop('disabled', false);\n                }\n                notification.alert(response.title, response.body, response.label);\n            }).fail(notification.exception).always(function() {\n                spinner.hide();\n            });\n        }\n\n        return criteriaSetSave;\n    }\n);\n"],"names":["define","$","ajax","notification","str","templates","ModalFactory","ModalEvents","init","contextId","canPublish","get_string","done","title","context","trigger","create","body","render","type","types","SAVE_CANCEL","large","modal","getFooter","find","prop","getRoot","on","save","e","preventDefault","modalNode","nameNode","rawName","val","trim","shared","spinner","name","charAt","toUpperCase","slice","show","criteria","parent","each","this","length","descText","descNode","next","text","push","description","call","methodname","args","contextid","response","hide","alert","label","fail","exception","always","saveSet","hidden"],"mappings":";;;;;;;;;;;AA0BAA,mDACI,CACI,SACA,YACA,oBACA,WACA,iBACA,qBACA,sBAEJ,SAASC,EAAGC,KAAMC,aAAcC,IAAKC,UAAWC,aAAcC,mBACpC,CAOlBC,KAAM,SAASC,UAAWC,YACtBN,IAAIO,WAAW,kBAAmB,6BAA6BC,MAAK,SAASC,WACrEC,QAAU,CACVJ,WAAYA,YAEZK,QAAUd,EAAE,6CAChBK,aAAaU,OAAO,CAChBH,MAAOA,MACPI,KAAMZ,UAAUa,OAAO,4CAA6CJ,SACpEK,KAAMb,aAAac,MAAMC,YACzBC,OAAO,GACRP,SAASH,MAAK,SAASW,OAEtBA,MAAMC,YAAYC,KAAK,wBAAwBC,KAAK,YAAY,GAChEH,MAAMI,UAAUC,GAAGrB,YAAYsB,MAAM,SAASC,GAC1CA,EAAEC,0BAoBLR,MAAOd,eAChBuB,UAAYT,MAAMI,UAClBM,SAAWD,UAAUP,KAAK,6BAC1BS,QAAUD,SAASE,MAAMC,OACzBC,QAAS,EACTC,QAAUN,UAAUP,KAAK,iBAEzBc,KAAOL,QAAQM,OAAO,GAAGC,cAAgBP,QAAQQ,MAAM,GAC3DT,SAASE,IAAII,MACTP,UAAUP,KAAK,gCAAgCC,KAAK,aACpDW,QAAS,GAEbC,QAAQK,WAEJC,SAAW,GACfZ,UAAUa,SAASA,SAASpB,KAAK,iDAAiDqB,MAAK,cAC/E7C,EAAE8C,MAAMZ,MAAMC,OAAOY,OAAQ,KAKzBC,SAJAC,SAAWjD,EAAE8C,MAAMF,SAASA,SAASM,OAAO1B,KAAK,gDAChDyB,SAASF,SACVE,SAAWjD,EAAE8C,MAAMF,SAASA,SAASM,OAAO1B,KAAK,gCAIjDwB,SADAC,SAASf,MACEe,SAASf,MAAMC,OACnBc,SAASE,OACLF,SAASE,OAAOhB,OAEhB,GAEfQ,SAASS,KAAK,CACVd,KAAMtC,EAAE8C,MAAMZ,MAAMC,OACpBkB,YAAaL,eAKX/C,KAAKqD,KAAK,CAAC,CACrBC,WAAY,6CACZC,KAAM,CACFC,UAAWjD,UACX8B,KAAMA,KACNK,SAAUA,SACVP,OAAQA,WAIR,GAAGzB,MAAK,SAAS+C,WACC,IAAlBA,SAASC,OACTrC,MAAMqC,OACN3D,EAAE,gDAAgDyB,KAAK,YAAY,IAEvEvB,aAAa0D,MAAMF,SAAS9C,MAAO8C,SAAS1C,KAAM0C,SAASG,UAC5DC,KAAK5D,aAAa6D,WAAWC,QAAO,WACnC3B,QAAQsB,UAxEIM,CAAQ3C,MAAOd,cAGnBc,MAAMI,UAAUC,GAAGrB,YAAY4D,QAAQ,WACnClE,EAAE8C,MAAMtB,KAAK,6BAA6BU,IAAI,IAC9ClC,EAAE8C,MAAMtB,KAAK,gCAAgCC,KAAK,WAAW,GAC7DzB,EAAE8C,MAAMtB,KAAK,wBAAwBC,KAAK,YAAY,SAE3DqC,KAAK5D,aAAa6D,cACtBD,KAAK5D,aAAa6D"}