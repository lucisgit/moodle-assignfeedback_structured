{"version":3,"file":"criteriasetsave.min.js","sources":["../src/criteriasetsave.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Launches a modal dialogue that enables users to save the configured criteria set for the structured feedback plugin.\n *\n * See template: assignfeedback_structured/criteriasetsave\n *\n * @module     assignfeedback_structured/criteriasetsave\n * @class      criteriasetsave\n * @copyright  2017 Lancaster University {@link http://www.lancaster.ac.uk/}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author     Tony Butler <a.butler4@lancaster.ac.uk>\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport {getString} from 'core/str';\nimport Templates from 'core/templates';\nimport {modalActive} from './criteriasets';\nimport CSSaveModal from './cssavemodal';\n\n/**\n * Init function.\n *\n * @param {number} contextId The context ID of the current assignment instance.\n * @param {boolean} canPublish Whether the current user can publish criteria sets.\n * @return {Promise} A promise.\n */\nexport const init = async(contextId, canPublish) => {\n    const title = await getString('criteriasetsave', 'assignfeedback_structured'),\n        button = document.querySelector('#id_assignfeedback_structured_critsetsave');\n    button.addEventListener('click', async() => {\n        const templateContext = {\n            contextId: contextId,\n            canPublish: canPublish,\n        };\n        const body = await Templates.render('assignfeedback_structured/criteriasetsave', templateContext);\n        const modal = await CSSaveModal.create({\n            title: title,\n            body: body,\n        });\n\n        // Display a spinner while the modal is active.\n        await modalActive(button);\n\n        const modalFooter = await modal.getFooter(),\n            modalBody = await modal.getBody(),\n            nameInput = modalBody.find('[name=\"criteriaset-name\"]'),\n            shareBox = modalBody.find('[name=\"criteriaset-publish\"]'),\n            saveButton = modalFooter.find(modal.getActionSelector('save'));\n\n        // Disable save button initially, and hide the loading icon.\n        modalFooter.find(modal.getActionSelector('save')).prop('disabled', true);\n        modalBody.find('.loading-icon').hide();\n\n        // Enable save button only if the name field contains some text.\n        nameInput.on('keyup blur', () => {\n            if (nameInput.val().trim()) {\n                saveButton.prop('disabled', false);\n            } else {\n                saveButton.prop('disabled', true);\n            }\n        });\n\n        // Fix a weird bug when hitting Enter on the name input field.\n        nameInput.on('keydown', (e) => {\n            if (e.keyCode === 13) {\n                e.preventDefault();\n                shareBox.focus();\n            }\n        });\n\n        // Fix same weird bug when hitting Enter on the 'share' checkbox.\n        shareBox.on('keydown', (e) => {\n            if (e.keyCode === 13) {\n                e.preventDefault();\n                saveButton.focus();\n            }\n        });\n\n        // Fix duplicate submission when hitting Enter on the save button.\n        saveButton.on('keydown', (e) => {\n            if (e.keyCode === 13) {\n                e.preventDefault();\n            }\n        });\n    });\n};\n\n/**\n * Function to gather the criteria data and call a web service method via AJAX to save as a named criteria set.\n *\n * @param {Object} modal The modal dialogue containing the criteria set save data.\n * @return {Promise} A promise.\n */\nexport const saveSet = async(modal) => {\n    const modalRoot = await modal.getRoot(),\n        contextId = modalRoot.find('.criteriasetsave-page').data('context'),\n        nameInput = modalRoot.find('[name=\"criteriaset-name\"]'),\n        rawName = nameInput.val().trim(),\n        spinner = modalRoot.find('.loading-icon');\n    let shared = false;\n\n    const name = rawName.charAt(0).toUpperCase() + rawName.slice(1);\n    nameInput.val(name);\n    if (modalRoot.find('[name=\"criteriaset-publish\"]').prop('checked')) {\n        shared = true;\n    }\n    spinner.show();\n\n    const criteria = [];\n    for (const name of document.querySelectorAll('input[id^=\"id_assignfeedback_structured_critname\"]')) {\n        if (name.value.trim().length) {\n            const descField = name.parentElement.parentElement.nextElementSibling\n                .querySelector('[name^=\"assignfeedback_structured_critdesc\"]');\n            let descText = '';\n            if (descField.value) {\n                descText = descField.value.trim();\n            } else if (descField.textContent) {\n                descText = descField.textContent.trim();\n            }\n            criteria.push({\n                name: name.value.trim(),\n                description: descText,\n            });\n        }\n    }\n\n    const request = Ajax.call([{\n        methodname: 'assignfeedback_structured_save_criteriaset',\n        args: {\n            contextid: contextId,\n            name: name,\n            criteria: criteria,\n            shared: shared,\n        },\n    }]);\n\n    const response = await request[0];\n    if (response.hide === true) {\n        modal.destroy();\n        document.querySelector('#id_assignfeedback_structured_critsetsmanage').disabled = false;\n    }\n    await Notification.alert(response.title, response.body, response.label);\n    spinner.hide();\n};\n"],"names":["async","contextId","canPublish","title","button","document","querySelector","addEventListener","templateContext","body","Templates","render","modal","CSSaveModal","create","modalFooter","getFooter","modalBody","getBody","nameInput","find","shareBox","saveButton","getActionSelector","prop","hide","on","val","trim","e","keyCode","preventDefault","focus","modalRoot","getRoot","data","rawName","spinner","shared","name","charAt","toUpperCase","slice","show","criteria","querySelectorAll","value","length","descField","parentElement","nextElementSibling","descText","textContent","push","description","request","Ajax","call","methodname","args","contextid","response","destroy","disabled","Notification","alert","label"],"mappings":";;;;;;;;;;;ySAyCoBA,MAAMC,UAAWC,oBAC3BC,YAAc,kBAAU,kBAAmB,6BAC7CC,OAASC,SAASC,cAAc,6CACpCF,OAAOG,iBAAiB,SAASP,gBACvBQ,gBAAkB,CACpBP,UAAWA,UACXC,WAAYA,YAEVO,WAAaC,mBAAUC,OAAO,4CAA6CH,iBAC3EI,YAAcC,qBAAYC,OAAO,CACnCX,MAAOA,MACPM,KAAMA,aAIJ,6BAAYL,cAEZW,kBAAoBH,MAAMI,YAC5BC,gBAAkBL,MAAMM,UACxBC,UAAYF,UAAUG,KAAK,6BAC3BC,SAAWJ,UAAUG,KAAK,gCAC1BE,WAAaP,YAAYK,KAAKR,MAAMW,kBAAkB,SAG1DR,YAAYK,KAAKR,MAAMW,kBAAkB,SAASC,KAAK,YAAY,GACnEP,UAAUG,KAAK,iBAAiBK,OAGhCN,UAAUO,GAAG,cAAc,KACnBP,UAAUQ,MAAMC,OAChBN,WAAWE,KAAK,YAAY,GAE5BF,WAAWE,KAAK,YAAY,MAKpCL,UAAUO,GAAG,WAAYG,IACH,KAAdA,EAAEC,UACFD,EAAEE,iBACFV,SAASW,YAKjBX,SAASK,GAAG,WAAYG,IACF,KAAdA,EAAEC,UACFD,EAAEE,iBACFT,WAAWU,YAKnBV,WAAWI,GAAG,WAAYG,IACJ,KAAdA,EAAEC,SACFD,EAAEE,yCAYK/B,MAAAA,cACbiC,gBAAkBrB,MAAMsB,UAC1BjC,UAAYgC,UAAUb,KAAK,yBAAyBe,KAAK,WACzDhB,UAAYc,UAAUb,KAAK,6BAC3BgB,QAAUjB,UAAUQ,MAAMC,OAC1BS,QAAUJ,UAAUb,KAAK,qBACzBkB,QAAS,QAEPC,KAAOH,QAAQI,OAAO,GAAGC,cAAgBL,QAAQM,MAAM,GAC7DvB,UAAUQ,IAAIY,MACVN,UAAUb,KAAK,gCAAgCI,KAAK,aACpDc,QAAS,GAEbD,QAAQM,aAEFC,SAAW,OACZ,MAAML,QAAQlC,SAASwC,iBAAiB,yDACrCN,KAAKO,MAAMlB,OAAOmB,OAAQ,OACpBC,UAAYT,KAAKU,cAAcA,cAAcC,mBAC9C5C,cAAc,oDACf6C,SAAW,GACXH,UAAUF,MACVK,SAAWH,UAAUF,MAAMlB,OACpBoB,UAAUI,cACjBD,SAAWH,UAAUI,YAAYxB,QAErCgB,SAASS,KAAK,CACVd,KAAMA,KAAKO,MAAMlB,OACjB0B,YAAaH,iBAKnBI,QAAUC,cAAKC,KAAK,CAAC,CACvBC,WAAY,6CACZC,KAAM,CACFC,UAAW3D,UACXsC,KAAMA,KACNK,SAAUA,SACVN,OAAQA,WAIVuB,eAAiBN,QAAQ,IACT,IAAlBM,SAASpC,OACTb,MAAMkD,UACNzD,SAASC,cAAc,gDAAgDyD,UAAW,SAEhFC,sBAAaC,MAAMJ,SAAS1D,MAAO0D,SAASpD,KAAMoD,SAASK,OACjE7B,QAAQZ"}